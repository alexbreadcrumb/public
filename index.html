<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Puzzle Musical</title>
    <style>
        :root {
            --bg-color: #121212;
            --primary-color: #1DB954;
            --card-color: #282828;
            --text-color: #FFFFFF;
            --text-muted-color: #B3B3B3;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .main-container {
            width: 100%;
            max-width: 480px;
            padding: 1rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex-grow: 1;
        }

        header {
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 2rem;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .puzzle-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* Aspect ratio 1:1 */
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        #puzzle-board {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 2px;
            background-color: #000;
        }
        
        #message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
            font-size: 1.2rem;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #message-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .puzzle-piece {
            background-size: 400% 400%;
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
        }

        .puzzle-piece:hover {
            transform: scale(0.95);
        }

        .puzzle-piece.empty {
            background-image: none !important;
            background-color: var(--bg-color);
            cursor: default;
        }
        .puzzle-piece.empty:hover {
            transform: none;
        }

        .stats-and-controls {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .stats-display {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted-color);
            text-transform: uppercase;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .control-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 0.8rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .control-btn:hover {
            background-color: #1ed760;
        }
        .control-btn:active {
            transform: scale(0.96);
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .high-scores {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
        }
        h2 {
            margin-top: 0;
            color: var(--primary-color);
        }
        #scores-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #scores-list li {
            background-color: var(--bg-color);
            padding: 0.5rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

        .footer {
            width: 100%;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
            background-color: #000;
            color: var(--text-muted-color);
            font-size: 0.8rem;
            position: sticky;
            bottom: 0;
        }

    </style>
</head>
<body>

    <div class="main-container">
        <header>
            <h1>Puzzle Musical</h1>
        </header>

        <main class="game-area">
            <div class="puzzle-container">
                <div id="puzzle-board"></div>
                <div id="message-overlay">Cargando...</div>
            </div>

            <div class="stats-and-controls">
                <div class="stats-display">
                    <div>
                        <div id="moves-count" class="stat">0</div>
                        <div class="stat-label">Movimientos</div>
                    </div>
                    <div>
                        <div id="timer" class="stat">00:00</div>
                        <div class="stat-label">Tiempo</div>
                    </div>
                </div>

                <div class="controls">
                    <button id="new-game-btn" class="control-btn">
                        <svg viewBox="0 0 24 24"><path d="M12 2.5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 12 2.5zm0 17a7.5 7.5 0 1 1 7.5-7.5 7.5 7.5 0 0 1-7.5 7.5z"/><path d="M12 6a1 1 0 0 0-1 1v4.586l-2.707 2.707a1 1 0 0 0 1.414 1.414L12 13.414V7a1 1 0 0 0-1-1z"/></svg>
                        Juego Nuevo
                    </button>
                    <button id="pause-btn" class="control-btn">
                        <span id="pause-icon"><svg viewBox="0 0 24 24"><path d="M8 7h2v10H8zm6 0h2v10h-2z"/></svg></span>
                        <span id="play-icon" style="display: none;"><svg viewBox="0 0 24 24"><path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/></svg></span>
                        <span id="pause-text">Pausar</span>
                    </button>
                    <button id="audio-btn" class="control-btn">
                         <span id="audio-on-icon"><svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg></span>
                        <span id="audio-off-icon" style="display: none;"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></span>
                        <span id="audio-text">Sonido</span>
                    </button>
                </div>
            </div>

            <section class="high-scores">
                <h2>Mejores Tiempos</h2>
                <ul id="scores-list">
                    <li>No hay récords aún</li>
                </ul>
            </section>
        </main>
        
        <footer class="footer">
            Game By: Ale Fernández 2025 - PY
        </footer>
    </div>
    
    <audio id="audio-player" loop crossorigin="anonymous"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const board = document.getElementById('puzzle-board');
            const movesCountEl = document.getElementById('moves-count');
            const timerEl = document.getElementById('timer');
            const newGameBtn = document.getElementById('new-game-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const pauseText = document.getElementById('pause-text');
            const pauseIcon = document.getElementById('pause-icon');
            const playIcon = document.getElementById('play-icon');
            const scoresList = document.getElementById('scores-list');
            const messageOverlay = document.getElementById('message-overlay');
            
            const audioBtn = document.getElementById('audio-btn');
            const audioOnIcon = document.getElementById('audio-on-icon');
            const audioOffIcon = document.getElementById('audio-off-icon');
            const audioPlayer = document.getElementById('audio-player');

            const SIZE = 4;
            const PIECE_COUNT = SIZE * SIZE;
            
            let pieces = [];
            let moves = 0;
            let time = 0;
            let timerInterval = null;
            let isPaused = true;
            let isSoundOn = false;
            let currentAlbum = null;

            function init() {
                loadGameState();
                renderHighScores();
                
                newGameBtn.addEventListener('click', () => {
                    if (confirm('¿Estás seguro de que quieres empezar un juego nuevo? Perderás tu progreso actual.')) {
                        startNewGame();
                    }
                });

                pauseBtn.addEventListener('click', togglePause);
                audioBtn.addEventListener('click', toggleSound);

                board.addEventListener('click', e => {
                    if (isPaused || !e.target.classList.contains('puzzle-piece')) return;
                    const pieceIndex = parseInt(e.target.dataset.index);
                    handlePieceClick(pieceIndex);
                });
            }
            
            function showMessage(msg) {
                messageOverlay.textContent = msg;
                messageOverlay.classList.add('visible');
            }

            function hideMessage() {
                messageOverlay.classList.remove('visible');
            }

            async function prepareNewGameData() {
                showMessage('Cargando portada...');
                try {
                    // Step 1: Reliably fetch album with art
                    const albumWithArt = await fetchAlbumWithArt();
                    if (!albumWithArt) throw new Error("No se pudo encontrar un álbum con portada.");

                    currentAlbum = albumWithArt;

                    // Immediately setup game with the image
                    const imageUrl = currentAlbum.artworkUrl100.replace('100x100', '600x600');
                    await preloadImage(imageUrl);
                    
                    initializeGame(imageUrl);
                    hideMessage();
                    
                    // Step 2: In the background, try to find audio
                    fetchAndSetAudio(currentAlbum.artistName, currentAlbum.collectionName);

                } catch (error) {
                    console.error('Error al preparar el juego:', error);
                    showMessage('No se pudo cargar una portada. Revisa tu conexión e intenta de nuevo.');
                }
            }

            async function fetchAlbumWithArt() {
                const genres = ['rock', 'pop', 'jazz', 'classical', 'electronic', 'hip-hop', 'reggae'];
                for (let i = 0; i < 5; i++) { // Try 5 times
                    try {
                        const randomGenre = genres[Math.floor(Math.random() * genres.length)];
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(`https://itunes.apple.com/search?term=${randomGenre}&media=music&entity=album&limit=50`)}`;
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        const validAlbums = data.results.filter(a => a.artworkUrl100);
                        if (validAlbums.length > 0) {
                            return validAlbums[Math.floor(Math.random() * validAlbums.length)];
                        }
                    } catch (error) {
                        console.error(`Intento ${i+1} fallido:`, error);
                    }
                }
                return null;
            }

            async function fetchAndSetAudio(artistName, albumName) {
                try {
                    const searchTerm = encodeURIComponent(`${artistName} ${albumName}`);
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(`https://itunes.apple.com/search?term=${searchTerm}&media=music&entity=song&limit=10`)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) return;
                    const data = await response.json();
                    
                    const songWithPreview = data.results.find(song => song.previewUrl);

                    if (songWithPreview) {
                        audioPlayer.src = songWithPreview.previewUrl;
                        if (isSoundOn) {
                           audioPlayer.play().catch(e => console.error("La reproducción de audio fue bloqueada.", e));
                        }
                    }
                } catch(error) {
                    console.error("Error al buscar audio:", error);
                }
            }

            function preloadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            }

            function initializeGame(imageUrl) {
                moves = 0;
                time = 0;
                isPaused = true;
                
                pieces = Array.from({ length: PIECE_COUNT }, (_, i) => ({
                    correctIndex: i,
                    currentIndex: i,
                    isEmpty: i === PIECE_COUNT - 1
                }));
                
                shufflePieces();
                renderBoard(imageUrl);
                updateUI();
            }

            function startNewGame() {
                clearInterval(timerInterval);
                timerInterval = null;
                audioPlayer.pause();
                audioPlayer.src = '';
                localStorage.removeItem('puzzleGameState');
                prepareNewGameData();
            }

            function shufflePieces() {
                // Fisher-Yates shuffle
                for (let i = pieces.length - 2; i > 0; i--) { // -2 to not shuffle the empty piece
                    const j = Math.floor(Math.random() * (i + 1));
                    [pieces[i].currentIndex, pieces[j].currentIndex] = [pieces[j].currentIndex, pieces[i].currentIndex];
                }
            }

            function renderBoard(imageUrl) {
                board.innerHTML = '';
                const sortedPieces = [...pieces].sort((a, b) => a.currentIndex - b.currentIndex);
                
                sortedPieces.forEach(piece => {
                    const pieceEl = document.createElement('div');
                    pieceEl.classList.add('puzzle-piece');
                    pieceEl.dataset.index = piece.currentIndex;
                    
                    if (piece.isEmpty) {
                        pieceEl.classList.add('empty');
                    } else {
                        const x = piece.correctIndex % SIZE;
                        const y = Math.floor(piece.correctIndex / SIZE);
                        pieceEl.style.backgroundImage = `url(${imageUrl})`;
                        pieceEl.style.backgroundPosition = `${(x * 100) / (SIZE - 1)}% ${(y * 100) / (SIZE - 1)}%`;
                    }
                    board.appendChild(pieceEl);
                });
            }

            function handlePieceClick(clickedIndex) {
                const emptyPiece = pieces.find(p => p.isEmpty);
                const clickedPiece = pieces.find(p => p.currentIndex === clickedIndex);
                
                if (!clickedPiece || clickedPiece.isEmpty) return;

                const emptyIndex = emptyPiece.currentIndex;
                const canMove = (
                    (Math.floor(clickedIndex / SIZE) === Math.floor(emptyIndex / SIZE) && Math.abs(clickedIndex - emptyIndex) === 1) ||
                    (clickedIndex % SIZE === emptyIndex % SIZE && Math.abs(clickedIndex - emptyIndex) === SIZE)
                );

                if (canMove) {
                    swapPieces(clickedPiece, emptyPiece);
                }
            }
            
            function swapPieces(piece1, piece2) {
                [piece1.currentIndex, piece2.currentIndex] = [piece2.currentIndex, piece1.currentIndex];
                
                moves++;
                renderBoard(currentAlbum.artworkUrl100.replace('100x100', '600x600')); // Re-render the entire board
                updateUI();

                if (checkWin()) {
                    handleWin();
                } else {
                    saveGameState();
                }
            }

            function checkWin() {
                return pieces.every(p => p.currentIndex === p.correctIndex);
            }

            function handleWin() {
                clearInterval(timerInterval);
                timerInterval = null;
                isPaused = true;
                audioPlayer.pause();
                
                const finalTime = formatTime(time);
                showMessage(`¡Ganaste!\nTiempo: ${finalTime}\nMovimientos: ${moves}`);
                
                setTimeout(() => {
                    saveHighScore(time);
                    renderHighScores();
                    localStorage.removeItem('puzzleGameState');
                }, 500);
            }

            function togglePause() {
                if (timerInterval === null && !checkWin()) { // Resume
                    isPaused = false;
                    timerInterval = setInterval(updateTimer, 1000);
                    if(isSoundOn && audioPlayer.src) audioPlayer.play().catch(e => console.log("Play interrupted"));
                } else { // Pause
                    isPaused = true;
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if(isSoundOn) audioPlayer.pause();
                }
                updateUI();
                saveGameState();
            }
            
            function toggleSound() {
                isSoundOn = !isSoundOn;
                if(isSoundOn) {
                    if (audioPlayer.src && !isPaused) {
                         audioPlayer.play().catch(e => {
                            console.error("Audio playback failed:", e);
                            isSoundOn = false; // Revert state if play fails
                        });
                    }
                } else {
                    audioPlayer.pause();
                }
                updateUI();
                saveGameState();
            }
            
            function updateTimer() {
                if (!isPaused) {
                    time++;
                    updateUI();
                    saveGameState();
                }
            }

            function updateUI() {
                movesCountEl.textContent = moves;
                timerEl.textContent = formatTime(time);
                
                // Pause/Play Button
                pauseText.textContent = isPaused ? 'Reanudar' : 'Pausar';
                playIcon.style.display = isPaused ? 'inline' : 'none';
                pauseIcon.style.display = isPaused ? 'none' : 'inline';
                
                // Sound Button
                audioOnIcon.style.display = isSoundOn ? 'none' : 'inline';
                audioOffIcon.style.display = isSoundOn ? 'inline' : 'none';
            }

            function formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            }
            
            function saveGameState() {
                if (checkWin()) return;
                const state = {
                    pieces: pieces.map(p => ({ ...p })),
                    moves,
                    time,
                    isPaused, // Save the actual state
                    isSoundOn,
                    currentAlbum
                };
                localStorage.setItem('puzzleGameState', JSON.stringify(state));
            }

            function loadGameState() {
                const savedState = localStorage.getItem('puzzleGameState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    pieces = state.pieces;
                    moves = state.moves;
                    time = state.time;
                    isPaused = true; // Always start paused when loading
                    isSoundOn = state.isSoundOn;
                    currentAlbum = state.currentAlbum;

                    const imageUrl = currentAlbum.artworkUrl100.replace('100x100', '600x600');
                    renderBoard(imageUrl);
                    updateUI();
                    hideMessage();
                    // Try to set audio in background
                    fetchAndSetAudio(currentAlbum.artistName, currentAlbum.collectionName);

                } else {
                    prepareNewGameData();
                }
            }

            function getHighScores() {
                return JSON.parse(localStorage.getItem('puzzleHighScores')) || [];
            }

            function saveHighScore(newTime) {
                const scores = getHighScores();
                const newEntry = {
                    time: newTime,
                    date: new Date().toLocaleDateString('es-ES')
                };
                scores.push(newEntry);
                scores.sort((a, b) => a.time - b.time);
                const topScores = scores.slice(0, 5);
                localStorage.setItem('puzzleHighScores', JSON.stringify(topScores));
            }

            function renderHighScores() {
                const scores = getHighScores();
                if (scores.length === 0) {
                    scoresList.innerHTML = '<li>No hay récords aún</li>';
                    return;
                }
                scoresList.innerHTML = scores.map(score => 
                    `<li><span>${score.date}</span><span>${formatTime(score.time)}</span></li>`
                ).join('');
            }

            init();
        });
    </script>
</body>
</html>
