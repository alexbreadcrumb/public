<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle de Imagen Aleatoria</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: sans-serif;
      background: #222;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    #puzzle {
      position: relative;
      width: 400px;
      height: 400px;
      border: 4px solid #fff;
      margin-bottom: 10px;
      touch-action: none;
    }

    .piece {
      position: absolute;
      box-sizing: border-box;
      border: 1px solid #333;
      background-size: 400px 400px;
      touch-action: none;
      user-select: none;
    }

    #message {
      font-size: 20px;
      margin-top: 10px;
    }

    #timer {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 20px;
      margin-bottom: 20px;
      cursor: pointer;
      font-size: 16px;
    }

    #fullImage {
      margin-top: 20px;
      display: none;
    }

    #fullImage img {
      max-width: 400px;
      border: 4px solid #fff;
    }
  </style>
</head>
<body>

  <button id="startBtn">üß© Iniciar Puzzle</button>
  <div id="timer">‚è±Ô∏è Tiempo: 00:00</div>
  <div id="puzzle"></div>
  <div id="message"></div>
  <div id="fullImage"><h3>‚úÖ Imagen resuelta:</h3><img id="finalImg" src=""></div>

  <script>
    const puzzle = document.getElementById('puzzle');
    const message = document.getElementById('message');
    const startBtn = document.getElementById('startBtn');
    const timerDisplay = document.getElementById('timer');
    const fullImageDiv = document.getElementById('fullImage');
    const finalImg = document.getElementById('finalImg');

    let cols = 4, rows = 4;
    let pieceWidth = 400 / cols;
    let pieceHeight = 400 / rows;
    let positions = [];
    let currentImage = '';
    let startTime = 0;
    let timerInterval = null;
    let gameWon = false;

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        timerDisplay.textContent = `‚è±Ô∏è Tiempo: ${formatTime(elapsed)}`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    function drawPuzzle() {
      puzzle.innerHTML = '';
      positions.forEach((pos, index) => {
        const x = (index % cols) * pieceWidth;
        const y = Math.floor(index / cols) * pieceHeight;
        const sx = (pos % cols) * pieceWidth;
        const sy = Math.floor(pos / cols) * pieceHeight;

        const div = document.createElement('div');
        div.classList.add('piece');
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.width = pieceWidth + 'px';
        div.style.height = pieceHeight + 'px';
        div.style.backgroundImage = `url(${currentImage})`;
        div.style.backgroundPosition = `-${sx}px -${sy}px`;
        div.dataset.index = index;
        div.dataset.pos = pos;

        // Eventos personalizados para mouse y touch
        enableDragging(div);

        puzzle.appendChild(div);
      });
    }

    function enableDragging(piece) {
      let startX, startY, draggedPiece, originalIndex;

      function onStart(e) {
        if (gameWon) return;

        e.preventDefault();
        draggedPiece = e.currentTarget;
        originalIndex = parseInt(draggedPiece.dataset.index);
        const rect = draggedPiece.getBoundingClientRect();

        if (e.touches) {
          startX = e.touches[0].clientX - rect.left;
          startY = e.touches[0].clientY - rect.top;
          document.addEventListener('touchmove', onMove);
          document.addEventListener('touchend', onEnd);
        } else {
          startX = e.clientX - rect.left;
          startY = e.clientY - rect.top;
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onEnd);
        }

        draggedPiece.style.zIndex = 1000;
      }

      function onMove(e) {
        if (!draggedPiece) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        const rect = puzzle.getBoundingClientRect();
        const x = clientX - rect.left - startX;
        const y = clientY - rect.top - startY;

        draggedPiece.style.left = `${x}px`;
        draggedPiece.style.top = `${y}px`;
      }

      function onEnd(e) {
        const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
        const rect = puzzle.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        const col = Math.floor(x / pieceWidth);
        const row = Math.floor(y / pieceHeight);
        const newIndex = row * cols + col;

        if (newIndex >= 0 && newIndex < positions.length) {
          [positions[originalIndex], positions[newIndex]] = [positions[newIndex], positions[originalIndex]];
        }

        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onEnd);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);

        draggedPiece = null;
        drawPuzzle();
        checkWin();
      }

      piece.addEventListener('mousedown', onStart);
      piece.addEventListener('touchstart', onStart, { passive: false });
    }

    function checkWin() {
      const isCorrect = positions.every((pos, idx) => pos === idx);
      if (isCorrect) {
        gameWon = true;
        stopTimer();
        const totalTime = Math.floor((Date.now() - startTime) / 1000);
        const formattedTime = formatTime(totalTime);
        message.textContent = `üéâ ¬°Ganaste en ${formattedTime} minutos!`;

        fullImageDiv.style.display = 'block';
        finalImg.src = currentImage;

        setTimeout(() => {
          alert(`üèÜ ¬°Puzzle completado!\nTiempo total: ${formattedTime}`);
        }, 200);
      }
    }

    startBtn.addEventListener('click', async () => {
      gameWon = false;
      message.textContent = '';
      fullImageDiv.style.display = 'none';
      timerDisplay.textContent = '‚è±Ô∏è Tiempo: 00:00';
      puzzle.innerHTML = '';

      try {
        const response = await fetch('https://picsum.photos/400');
        currentImage = response.url;
        finalImg.src = '';
        positions = Array.from({ length: cols * rows }, (_, i) => i);
        for (let i = positions.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        drawPuzzle();
        startTimer();
      } catch (e) {
        message.textContent = '‚ùå Error al cargar la imagen.';
      }
    });
  </script>
</body>
</html>
